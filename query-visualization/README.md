# Query Visualization

`query-visualization`??`text-to-sql` ?濡ろ뜏???`user_query`, `sql`, `rows`)??????곸죷?袁⑸즵?룸돁??
??嚥▲꺃????⑤베毓?? ????れ삀??뫢??濡ろ떟?癲? 癲ル슓堉곁땟????獄쏅똻?? ?嶺뚮ㅎ????熬곣뫀肄???釉먯뒠??????얜Ŧ類??嚥▲꺂痢?API ??筌먐삳４???源낆뿷????덊렡.

## Quick Start

```bash
docker compose -f query-visualization/deploy/compose/docker-compose.yml up -d --build
```

- API: `http://localhost:8080`
- UI: repo root `ui` (`http://localhost:3000`)를 사용

## API Contract

### Request

`POST /visualize`

| field | type | note |
| --- | --- | --- |
| `user_query` | `string` | 1~4,000 chars (default, `VIS_MAX_QUERY_TEXT_LENGTH`) |
| `sql` | `string` | 1~12,000 chars (default, `VIS_MAX_SQL_TEXT_LENGTH`) |
| `rows` | `array<object>` | max 10,000 rows (default, `VIS_MAX_ROWS`) |

### Response

| field | type | note |
| --- | --- | --- |
| `sql` | `string` | original sql |
| `table_preview` | `array<object>` | first 20 rows |
| `analyses` | `array<object>` | chart recommendation cards |
| `insight` | `string` | llm/fallback insight |
| `fallback_used` | `boolean` | whether relaxed retry was used |
| `fallback_stage` | `string \| null` | retry stage name |
| `failure_reasons` | `array<string>` | failure reasons collected during pipeline |
| `attempt_count` | `number` | 1(normal), 2(relaxed retry) |
| `request_id` | `string \| null` | trace id |
| `total_latency_ms` | `number \| null` | end-to-end latency |
| `stage_latency_ms` | `object` | per-stage latency map |

### Error Codes

| code | http | description |
| --- | --- | --- |
| `ROWS_LIMIT_EXCEEDED` | 413 | `rows` exceeds 10,000 |
| `INVALID_ROWS` | 422 | `rows` is not `array<object>` |
| `ANALYSIS_IMPORT_ERROR` | 501 | analysis module import error |
| `DB_TEST_FAILED` | 500 | db-test endpoint failure |

## Pipeline

1. `rows -> DataFrame` ?怨뚮뼚???
2. elapsed ??濡ル㎥???????`elapsed_icu_days`, `elapsed_admit_days`)
3. ???袁る욑┼???釉먯뒠????獄쏅똻??
4. RAG ?濡ろ떟?????????類??????ш낄援??????
5. ??嚥▲꺃????⑤베毓??LLM + fallback)
6. ????釉먯뒭?????????獄쏅똻??normal)
7. 癲ル슓堉곁땟????獄쏅똻??
8. ????됰꽡 ??relaxed 癲ル슢?꾤땟????????
9. ?嶺뚮ㅎ????熬곣뫀肄???獄쏅똻??LLM ????됰꽡 ???????fallback)

## Recent Hardening (1~8)

1. ?嶺뚮ㅎ?듸쭕?????뚮듋??嚥싲갭?泳?낑?????쒓낯?? 
   - `src/db/schema_introspect.py` ?????
2. ??룰퀬?節덇덩?쒕굞????됰슣維?? 
   - `src/agent/rule_engine_postprocess.py`??plan ??ш끽維??????Β?띾쭡??筌믨퀡彛???됰슣維??
3. ???癲ル슣?????熬곣뫀???? 
   - `src/metrics/evaluator.py`, `scripts/evaluate_pipeline.py`
4. ???獒???怨뚮옖???? 
   - `tests/test_api_server.py` (payload ????モ뵲)  
   - `tests/test_analysis_agent.py` ???濡ろ뜏???fallback ???읐???⑤８痢? 
   - `tests/test_rule_engine.py` ??筌뤿걩???group 癲ル슓堉곁땟??????읐???⑤８痢?
5. ???굿癲ル쉵?猷????좊즴甕?? 
   - `src/utils/logging.py` ????깼???JSON ?棺??짆?? 
   - request ???쒙쭕?`request_id` ??⑤베毓??
6. API ??節뚮쳮????좊즴甕?? 
   - ??ヂ?筌????繹먮굝鍮?????モ뵲, ??? ?????熬곣뫀???
7. RAG ???源녿뼥 ??좊읈??? 
   - `RAG_MIN_SCORE`, `RAG_DOC_VERSION`, `RAG_CONTEXT_MAX_CHARS`
8. ?????????癲ル슣鍮섌뜮蹂좊쨨?? 
   - ???쑩?젆??stage latency/fallback ?嶺뚮㉡?€쾮??嶺뚮ㅎ???

## Evaluation Metrics

??? ???袁⑹뵫?繹???

```bash
cd query-visualization
python scripts/evaluate_pipeline.py
```

??れ삀??????Β???癲ル슣????

- `render_success_rate_pct`: 癲ル슓堉곁땟????獄쏅똻???濚밸Þ?볠쾮??
- `fallback_rate_pct`: fallback ?????????
- `failure_free_rate_pct`: failure reason ????몄툗 ?????
- `avg_latency_ms`: ????????쑩?젆?癲ル슣?????Β?ル빰??
- `max_latency_ms`: 癲ル슔?됭짆? ???쑩?젆?癲ル슣?????Β?ル빰??

??⑥レ툓?????怨뺣빰 ?嶺뚮Ĳ?뉛쭛?

```json
{
  "case_count": 3,
  "render_success_rate_pct": 66.67,
  "fallback_rate_pct": 33.33,
  "failure_free_rate_pct": 0.0,
  "avg_latency_ms": 202.35,
  "max_latency_ms": 519.7,
  "results": []
}
```

## Important Environment Variables

| name | default | note |
| --- | --- | --- |
| `OPENAI_API_KEY` | - | required for llm/embedding |
| `OPENAI_EMBEDDING_MODEL` | `text-embedding-3-small` | embedding model |
| `MONGODB_URI` | - | atlas connection |
| `RAG_TOP_K` | `6` | top-k retrieval |
| `RAG_MIN_SCORE` | `0.2` | retrieval score threshold |
| `RAG_CONTEXT_MAX_CHARS` | `4000` | max context length |
| `RAG_DOC_VERSION` | `v1` | document version filter |
| `VIS_MAX_QUERY_TEXT_LENGTH` | `4000` | visualize request `user_query` max length |
| `VIS_MAX_SQL_TEXT_LENGTH` | `12000` | visualize request `sql` max length |
| `VIS_MAX_ROWS` | `10000` | visualize request rows limit |
